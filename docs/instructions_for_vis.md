# プロジェクト「eth-river-vis」AI 向け引き継ぎサマリー

## 1. プロジェクトの目的とゴール

-   **目的**: マシン 1 (pyshark) および マシン 2 (Kinect) から送信される OSC メッセージをリアルタイムで受信し、ネットワークパケットと物理的な介入を「光の川」として可視化する、インタラクティブ・インスタレーションの描画エンジンを実装する。
-   **コンポーネントの役割**:
    1.  **OSC 受信**: 2 系統の OSC データ（パケット情報、Kinect 情報）を受信する。
    2.  **データ解釈**: 受信したパケットメタデータ（プロトコル, IP, 長さ）に基づき、粒子の属性（色, サイズ, 方向）を決定する。
    3.  **シミュレーション**: パーティクル・システムを管理し、物理演算（現在はレベル 1）を実行する。
    4.  **介入処理**: Kinect からの OSC データ（石の位置など）に基づき、パーティクルの物理演算に「介入」するロジックを適用する。
    5.  **描画**: シミュレーション結果を Processing のウィンドウに描画する。

---

## 2. 主要な技術スタック

-   **担当マシン**: マシン 3 (Raspberry Pi 5)
-   **言語**: **Java 17**
-   **フレームワーク**: **Processing 4** (PApplet クラスを継承)
-   **ビルドシステム**: **Gradle**
-   **主要ライブラリ**:
    -   **`oscP5`**: OSC 通信の受信用ライブラリ。
-   **設定ファイル**:
    -   `src/main/resources/config.properties`
    -   `src/main/resources/secrets.properties`
    -   （注: 現在はファイル読み込みロジックが一時的に無効化されており、ハードコーディングで対応中）

---

## 3. 現状の ToDo リストと進捗

### 完了済み

-   **P0: OSC 受信 (pyshark)**: `oscP5` を使用し、ポート `12345` でマシン 1 (pyshark) からの OSC メッセージ受信に成功。
-   **P1: パーティクルシステム (レベル 1)**:
    -   `Particle` クラス（位置, 速度, 色, サイズ）を実装。
    -   `ArrayList<Particle>` でパーティクルを管理。
    -   `oscEvent` で受信したデータ（プロトコル, パケット長）に基づき、色とサイズを変えてパーティクルを生成。
-   **P1: 方向性（上下）の実装**:
    -   `localNetPrefix` 変数（ハードコーディング）に基づき、`srcIp` と `dstIp` を比較。
    -   「Upstream」（下から上へ）と「Downstream」（上から下へ）で、パーティクルの発生位置と初期速度を変更するロジックを実装済み。
-   **P1: 安全なパーティクル削除**: `draw()` ループ内で `ArrayList` を**逆順（後ろから）**処理し、`isDead()`（画面外判定）で安全に要素を削除するロジックを実装済み。

### 未完了（次のタスク）

| 優先度     | タスク                        | 担当ファイル                  | 詳細                                                                                                                                                                                      |
| :--------- | :---------------------------- | :---------------------------- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **P2-III** | **Kinect OSC 受信スタブ作成** | `Main.java`                   | マシン 2 (Kinect) からの OSC（仮仕様: `/kinect/object` @ `12346`）を受信する `oscP5.plug()` と、それを受け取るコールバック関数（例: `kinectObjectEvent()`）を実装する。                   |
| **P2-IV**  | **「介入」ロジック実装**      | `Main.java` (Particle クラス) | P2-III で受信した「石」の座標（X, Y）を `Particle` クラスの `update()` に渡し、粒子がその座標を避ける、または引き寄せられる（「ダム」「磁石」）ロジックを実装する。                       |
| **P3-Vis** | **TCP 制御パケットの可視化**  | `Main.java` (oscEvent)        | `pyshark` 側で今後実装される `/packet/tcp_syn` や `/packet/tcp_fin` を受信した際に、寿命（Lifespan）が短く、色が異なる（白など）パーティクルを生成する処理を追加する。                    |
| **P3-Sim** | **シミュレーション高度化**    | `Main.java` (Particle クラス) | `Particle` クラスに「加速度 (`PVector acc`)」と `applyForce(PVector force)` メソッドを追加し、粒子同士が反発する力や、Kinect の座標に反応する力を計算するロジック（レベル 3）を実装する。 |
| **P3-Vis** | **プロトコル色の追加**        | `Main.java` (oscEvent)        | `pyshark` 側で今後実装される `/packet/quic_hello` などの新しいプロトコルに対応し、色分けを追加する。                                                                                      |

---

## 4. これまでに決定した重要な仕様・設計

-   **OSC 仕様 (pyshark から)**: ポート `12345` で受信。
    -   **アドレス**: `/packet/{protocol_name}` (例: `/packet/dns`, `/packet/tls_hello`)。
    -   **引数 (順序固定)**:
        1.  `String`: プロトコル名 (例: "DNS", "TLS-Hello")
        2.  `int`: パケット長 (例: 120)
        3.  `String`: 詳細 (例: "SNI: google.com")
        4.  `String`: 送信元 IP (例: "192.168.11.50")
        5.  `String`: 宛先 IP (例: "1.1.1.1")
-   **OSC 仕様 (Kinect から)**: （仮仕様）
    -   **ポート**: `12346` （`12345` とは別）
    -   **アドレス**: `/kinect/object`
    -   **引数**: `int` (ID), `float` (x), `float` (y), `float` (angle)
-   **方向判定ロジック**:
    -   `localNetPrefix` 変数（ハードコーディング）と `ip.startsWith()` で `srcIsLocal` と `dstIsLocal` を判定。
    -   `srcIsLocal && !dstIsLocal` → **Upstream**（下から上へ）
    -   `!srcIsLocal && dstIsLocal` → **Downstream**（上から下へ）
    -   その他（Local, Unknown） → **Downstream**（上から下へ）
-   **パーティクルクラス (`Particle`)**:
    -   以下の属性を持つ: `PVector pos`, `PVector vel`, `color c`, `float size`。
    -   `update()`: `pos.add(vel)` というレベル 1 の物理演算を実装。
    -   `isDead()`: `pos.y` が画面外（上下）に出たか判定する。

---

## 5. 現在抱えている課題や懸念点

-   **パフォーマンス懸念**: 現在のマシン 3 (RPi 5) 上の Processing で、パーティクル数が数千を超えたり、P3-Sim（高度な物理演算）や P2-IV（Kinect 介入）を実装したりした際の**フレームレート低下**が最大の懸念事項。
-   **Kinect 連携 (未着手)**: マシン 2 (Kinect) が未開発であり、マシン 3 側は P2-III（受信スタブ）から実装を開始する必要がある。
-   **未実装の可視化**: `pyshark` 側で今後実装される `TCP-SYN` や `QUIC` パケットを受信した際の、専用の描画ロジック（色分け、寿命）が `Main.java` 側に未実装。
